<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug API Connection</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .test {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #0f0;
        }
        .error {
            color: #f00;
        }
        .success {
            color: #0f0;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>API Debug Console</h1>
    <div id="tests"></div>

    <script>
        const testsEl = document.getElementById('tests');
        
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            testsEl.appendChild(div);
        }

        async function runTests() {
            log('Starting API tests...');
            
            // Test 1: Direct API call
            log('\n=== Test 1: Direct API Call ===');
            try {
                log('Fetching: https://markets-feeds.r-bhuvanesh2007.workers.dev/api/sources');
                const response = await fetch('https://markets-feeds.r-bhuvanesh2007.workers.dev/api/sources');
                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                const data = await response.json();
                log(`Success! Received ${data.length} sources`);
                log(`First source: ${JSON.stringify(data[0], null, 2)}`);
            } catch (error) {
                log(`Error: ${error.message}`, true);
                log(`Error stack: ${error.stack}`, true);
            }

            // Test 2: Check CORS
            log('\n=== Test 2: CORS Test ===');
            try {
                const response = await fetch('https://markets-feeds.r-bhuvanesh2007.workers.dev/api/sources', {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                log(`CORS test passed! Status: ${response.status}`);
            } catch (error) {
                log(`CORS error: ${error.message}`, true);
            }

            // Test 3: Articles endpoint
            log('\n=== Test 3: Articles Endpoint ===');
            try {
                const response = await fetch('https://markets-feeds.r-bhuvanesh2007.workers.dev/api/articles?limit=5');
                const data = await response.json();
                log(`Received ${data.articles?.length || 0} articles`);
                if (data.articles?.length > 0) {
                    log(`First article: ${data.articles[0].title}`);
                }
            } catch (error) {
                log(`Error: ${error.message}`, true);
            }

            // Test 4: Check if the issue is with the FeedAPI class
            log('\n=== Test 4: FeedAPI Class Test ===');
            try {
                class TestFeedAPI {
                    constructor(baseUrl = 'https://markets-feeds.r-bhuvanesh2007.workers.dev') {
                        this.baseUrl = baseUrl;
                    }

                    async getSources() {
                        log(`TestFeedAPI: Fetching from ${this.baseUrl}/api/sources`);
                        try {
                            const response = await fetch(`${this.baseUrl}/api/sources`, {
                                cache: 'no-cache',
                                headers: {
                                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                                    'Pragma': 'no-cache',
                                    'Expires': '0'
                                }
                            });
                            log(`TestFeedAPI: Response status: ${response.status}`);
                            if (!response.ok) throw new Error(`API error: ${response.status}`);
                            const sources = await response.json();
                            log(`TestFeedAPI: Loaded ${sources.length} sources`);
                            return sources;
                        } catch (error) {
                            log(`TestFeedAPI Error: ${error.message}`, true);
                            return [];
                        }
                    }
                }

                const api = new TestFeedAPI();
                const sources = await api.getSources();
                log(`FeedAPI class test: ${sources.length > 0 ? 'SUCCESS' : 'FAILED'}`);
            } catch (error) {
                log(`Class test error: ${error.message}`, true);
            }

            // Test 5: Network timing
            log('\n=== Test 5: Network Performance ===');
            try {
                const start = performance.now();
                const response = await fetch('https://markets-feeds.r-bhuvanesh2007.workers.dev/api/sources');
                const end = performance.now();
                log(`API response time: ${(end - start).toFixed(2)}ms`);
                
                const dataStart = performance.now();
                await response.json();
                const dataEnd = performance.now();
                log(`JSON parsing time: ${(dataEnd - dataStart).toFixed(2)}ms`);
            } catch (error) {
                log(`Performance test error: ${error.message}`, true);
            }

            log('\n=== All tests complete ===');
            log('Open browser DevTools Console for more details');
        }

        // Run tests on load
        runTests();

        // Also log to browser console
        console.log('Debug page loaded. Check the page output for test results.');
    </script>
</body>
</html>