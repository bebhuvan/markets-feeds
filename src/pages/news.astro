---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import CategoryHeader from '../components/CategoryHeader.astro';
import LinkCard from '../components/LinkCard.astro';
import type { FeedItem } from '../types';
import '../styles/global.css';

// Load recent link data for news content - limit to latest 10 files
const linkFiles = await Astro.glob('../content/links/*.json');
const sortedFiles = linkFiles.sort((a, b) => {
  const dateA = a.url?.match(/(\d{4}-\d{2}-\d{2})\.json$/)?.[1] || '0000-00-00';
  const dateB = b.url?.match(/(\d{4}-\d{2}-\d{2})\.json$/)?.[1] || '0000-00-00';
  return dateB.localeCompare(dateA);
});

// Load the latest 10 files for better news content coverage
const recentFiles = sortedFiles.slice(0, 10);
const allLinks: FeedItem[] = [];

for (const file of recentFiles) {
  if (Array.isArray(file.default)) {
    allLinks.push(...file.default.filter((item: FeedItem) => 
      item.category === 'markets' || item.category === 'macro'
    ));
  }
}

// Sort by published date
allLinks.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// Pagination logic
const ARTICLES_PER_PAGE = 25;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const totalPages = Math.ceil(allLinks.length / ARTICLES_PER_PAGE);
const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
const endIndex = startIndex + ARTICLES_PER_PAGE;
const displayedLinks = allLinks.slice(startIndex, endIndex);

// Pagination info
const showingStart = startIndex + 1;
const showingEnd = Math.min(endIndex, allLinks.length);
const hasPrevPage = currentPage > 1;
const hasNextPage = currentPage < totalPages;
---

<Layout title="Market News - Markets Feeds" description="Latest financial news and market updates">
  <div class="container max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-12 overflow-x-hidden">
    <CategoryHeader title="Market News" currentPage="news">
      <div slot="filters" class="flex flex-wrap gap-2 mb-6">
        <button class="filter-btn active" data-filter="all">
          All
        </button>
        <button class="filter-btn" data-filter="markets">
          Markets
        </button>
        <button class="filter-btn" data-filter="macro">
          Macro
        </button>
      </div>
    </CategoryHeader>
    
    <Navigation currentPage="news" />
    
    <!-- Pagination Info -->
    {allLinks.length > 0 && (
      <div class="mb-6 text-sm text-text-subtle text-center">
        Showing {showingStart}-{showingEnd} of {allLinks.length} news articles
      </div>
    )}
    
    <main id="linkStream">
      {displayedLinks.length > 0 ? (
        <div>
          {displayedLinks.map((link) => (
            <LinkCard link={link} />
          ))}
        </div>
      ) : (
        <div class="py-12 text-center text-text-subtle">
          <p>No news available</p>
        </div>
      )}
    </main>
    
    <div id="emptyState" class="hidden py-12 text-center text-text-subtle">
      <p>No results found</p>
    </div>
    
    <!-- Pagination Controls -->
    {totalPages > 1 && (
      <div class="flex justify-center items-center gap-4 mt-8 pt-8 border-t border-border">
        {hasPrevPage ? (
          <a 
            href={`/news?page=${currentPage - 1}`}
            class="flex items-center gap-2 px-4 py-2 text-sm bg-card border border-border rounded-lg hover:bg-card-hover transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Previous
          </a>
        ) : (
          <div class="flex items-center gap-2 px-4 py-2 text-sm text-text-subtle">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Previous
          </div>
        )}
        
        <span class="text-sm text-text-subtle">
          Page {currentPage} of {totalPages}
        </span>
        
        {hasNextPage ? (
          <a 
            href={`/news?page=${currentPage + 1}`}
            class="flex items-center gap-2 px-4 py-2 text-sm bg-card border border-border rounded-lg hover:bg-card-hover transition-colors"
          >
            Next
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        ) : (
          <div class="flex items-center gap-2 px-4 py-2 text-sm text-text-subtle">
            Next
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        )}
      </div>
    )}
  </div>
  
  <style>
    .filter-btn {
      @apply px-3 py-1.5 text-sm text-text-subtle hover:text-text transition-colors rounded-md hover:bg-accent;
    }
    .filter-btn.active {
      @apply text-text bg-accent;
    }
  </style>
  
  <script>
    // Filter functionality
    const filterBtns = document.querySelectorAll('.filter-btn');
    const linkItems = document.querySelectorAll('.link-item');
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const emptyState = document.getElementById('emptyState');
    const linkStream = document.getElementById('linkStream');
    
    let currentFilter = 'all';
    let searchTerm = '';
    
    // Filter by category
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.getAttribute('data-filter') || 'all';
        applyFilters();
      });
    });
    
    // Search functionality
    searchInput.addEventListener('input', () => {
      searchTerm = searchInput.value.toLowerCase();
      applyFilters();
    });
    
    function applyFilters() {
      let visibleCount = 0;
      
      linkItems.forEach(item => {
        const category = item.getAttribute('data-category');
        const title = item.querySelector('h2')?.textContent?.toLowerCase() || '';
        const summary = item.querySelector('p')?.textContent?.toLowerCase() || '';
        const tags = item.getAttribute('data-tags')?.toLowerCase() || '';
        
        const matchesFilter = currentFilter === 'all' || category === currentFilter;
        const matchesSearch = searchTerm === '' || 
          title.includes(searchTerm) || 
          summary.includes(searchTerm) ||
          tags.includes(searchTerm);
        
        if (matchesFilter && matchesSearch) {
          (item as HTMLElement).style.display = 'block';
          visibleCount++;
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
      
      // Show/hide empty state
      if (visibleCount === 0) {
        linkStream?.classList.add('hidden');
        emptyState?.classList.remove('hidden');
      } else {
        linkStream?.classList.remove('hidden');
        emptyState?.classList.add('hidden');
      }
    }
    
    // Global function for tag clicking
    (window as any).filterByTag = function(tag: string) {
      searchInput.value = tag.toLowerCase();
      searchTerm = tag.toLowerCase();
      applyFilters();
      searchInput.focus();
    };
  </script>
</Layout>