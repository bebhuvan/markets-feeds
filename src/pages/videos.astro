---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import CategoryHeader from '../components/CategoryHeader.astro';
import LinkCard from '../components/LinkCard.astro';
import type { FeedItem } from '../types';
import '../styles/global.css';

// Load recent link data for performance - load latest 8 files for better video coverage
const linkFiles = await Astro.glob('../content/links/*.json');

// Sort files by date from filename (URL-based sorting - reliable)
const sortedFiles = linkFiles
  .filter(file => !file.url?.includes('sample-data.json'))
  .sort((a, b) => {
    const dateA = a.url?.match(/(2025-\d{2}-\d{2})\.json$/)?.[1] || '2000-01-01';
    const dateB = b.url?.match(/(2025-\d{2}-\d{2})\.json$/)?.[1] || '2000-01-01';
    return dateB.localeCompare(dateA);
  });

// Load the latest 8 files to get comprehensive video content
const recentFiles = sortedFiles.slice(0, 8);
const allLinks: FeedItem[] = [];

for (const file of recentFiles) {
  if (Array.isArray(file.default)) {
    const videoItems = file.default.filter((item: FeedItem) => 
      item.category === 'videos'
    );
    allLinks.push(...videoItems);
  }
}

// Sort by published date
allLinks.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// Pagination logic
const ARTICLES_PER_PAGE = 15;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const totalPages = Math.ceil(allLinks.length / ARTICLES_PER_PAGE);
const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
const endIndex = startIndex + ARTICLES_PER_PAGE;
const displayedLinks = allLinks.slice(startIndex, endIndex);

// Pagination info
const showingStart = startIndex + 1;
const showingEnd = Math.min(endIndex, allLinks.length);
const hasPrevPage = currentPage > 1;
const hasNextPage = currentPage < totalPages;

---

<Layout title="Videos - Markets Feeds" description="Latest financial and business videos from YouTube channels">
  
  <div class="container max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-12 overflow-x-hidden">
    <CategoryHeader title="Videos" currentPage="videos" />
    
    <Navigation currentPage="videos" />
    
    <!-- Feed Items -->
    <div class="space-y-0">
      {displayedLinks.length === 0 ? (
        <div class="text-center py-12">
          <p class="text-text-subtle mb-4">No videos available at the moment.</p>
          <p class="text-text-subtle text-sm">Video feeds are currently being set up. Check back soon!</p>
        </div>
      ) : (
        <div>
          <!-- Show pagination info -->
          <div class="flex justify-between items-center mb-6 text-sm text-text-subtle">
            <div>Showing {showingStart}-{showingEnd} of {allLinks.length} videos</div>
            <div>Page {currentPage} of {totalPages}</div>
          </div>
          
          {displayedLinks.map((link) => (
            <div class="video-card">
              <LinkCard link={link} />
              {/* Add YouTube video preview if it's a YouTube link */}
              {link.url.includes('youtube.com') && (
                <div class="video-preview mt-3">
                  <div class="video-indicator">
                    üé• YouTube Video
                  </div>
                </div>
              )}
            </div>
          ))}
          
          <!-- Pagination controls -->
          {totalPages > 1 && (
            <div class="flex justify-center items-center gap-4 mt-8 pt-6 border-t border-border">
              {hasPrevPage && (
                <a 
                  href={`/videos?page=${currentPage - 1}`}
                  class="btn-secondary flex items-center gap-2 px-4 py-2"
                >
                  ‚Üê Previous
                </a>
              )}
              
              <span class="px-4 py-2 text-sm text-text-subtle">
                Page {currentPage} of {totalPages}
              </span>
              
              {hasNextPage && (
                <a 
                  href={`/videos?page=${currentPage + 1}`}
                  class="btn-secondary flex items-center gap-2 px-4 py-2"
                >
                  Next ‚Üí
                </a>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  </div>
</Layout>

<style>
  /* Prevent horizontal scrolling */
  * {
    box-sizing: border-box;
  }
  
  .container {
    width: 100%;
    max-width: 100vw;
    overflow-x: hidden;
  }
  
  .video-card {
    position: relative;
    width: 100%;
    max-width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }
  
  .video-preview {
    padding-left: 16px;
  }
  
  .video-indicator {
    font-size: 12px;
    color: #dc2626;
    background: #fef2f2;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    border: 1px solid #fecaca;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Make video links more prominent */
  .video-card :global(.article-title a) {
    display: flex;
    align-items: center;
    gap: 8px;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    max-width: 100%;
  }
  
  .video-card :global(.article-title a):before {
    content: "‚ñ∂Ô∏è";
    font-size: 14px;
    flex-shrink: 0;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .video-card :global(.article-title a) {
      font-size: 16px;
      line-height: 1.4;
    }
    
    .video-indicator {
      font-size: 11px;
      padding: 3px 6px;
    }
  }
  
  @media (max-width: 480px) {
    .video-card :global(.article-title a) {
      font-size: 15px;
      gap: 6px;
    }
    
    .video-preview {
      padding-left: 12px;
    }
  }
</style>