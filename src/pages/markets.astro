---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import CategoryHeader from '../components/CategoryHeader.astro';
import LinkCard from '../components/LinkCard.astro';
import type { FeedItem } from '../types';
import '../styles/global.css';

// Load only recent link data for performance - limit to latest 3 files
const linkFiles = await Astro.glob('../content/links/*.json');
const sortedFiles = linkFiles.sort((a, b) => {
  const dateA = a.url?.match(/(\d{4}-\d{2}-\d{2})\.json$/)?.[1] || '0000-00-00';
  const dateB = b.url?.match(/(\d{4}-\d{2}-\d{2})\.json$/)?.[1] || '0000-00-00';
  return dateB.localeCompare(dateA);
});

// Load only the latest 3 files to reduce initial load time
const recentFiles = sortedFiles.slice(0, 3);
const allLinks: FeedItem[] = [];

for (const file of recentFiles) {
  if (Array.isArray(file.default)) {
    allLinks.push(...file.default.filter((item: FeedItem) => 
      item.category === 'markets'
    ));
  }
}

// Sort by published date and limit to 50 most recent articles
allLinks.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());
const displayedLinks = allLinks.slice(0, 50);
---

<Layout title="Markets - Markets Feeds" description="Latest market news, trading insights and financial market analysis">
  
  <div class="container max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-12 overflow-x-hidden">
    <CategoryHeader title="Markets" currentPage="markets" />
    
    <Navigation currentPage="markets" />
    
    <!-- Feed Items -->
    <div class="space-y-0">
      {displayedLinks.length === 0 ? (
        <div class="text-center py-12">
          <p class="text-text-subtle">No market updates available at the moment.</p>
        </div>
      ) : (
        displayedLinks.map((link) => (
          <LinkCard link={link} />
        ))
      )}
    </div>
  </div>
</Layout>