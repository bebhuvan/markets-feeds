---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import CategoryHeader from '../components/CategoryHeader.astro';
import LinkCard from '../components/LinkCard.astro';
import type { FeedItem } from '../types';
import '../styles/global.css';

// Load recent link data for technology content with error handling
let linkFiles: any[] = [];
let allLinks: FeedItem[] = [];

try {
  linkFiles = await Astro.glob('../content/links/*.json');
  
  // Sort files by date from filename (URL-based sorting - reliable)
  const sortedFiles = linkFiles
    .filter(file => file.url && !file.url.includes('sample-data.json'))
    .sort((a, b) => {
      const dateA = a.url?.match(/(2025-\d{2}-\d{2})\.json$/)?.[1] || '2000-01-01';
      const dateB = b.url?.match(/(2025-\d{2}-\d{2})\.json$/)?.[1] || '2000-01-01';
      return dateB.localeCompare(dateA);
    });

  // Load the latest 10 files for better technology content coverage
  const recentFiles = sortedFiles.slice(0, 10);

  for (const file of recentFiles) {
    try {
      if (Array.isArray(file.default)) {
        const techItems = file.default.filter((item: FeedItem) => 
          item && item.category === 'technology' && item.title && item.url
        );
        allLinks.push(...techItems);
      }
    } catch (fileError) {
      console.error(`Error processing file ${file.url}:`, fileError);
    }
  }
} catch (error) {
  console.error('Error loading link files:', error);
}

// Debug information
console.log(`Technology page debug - ${new Date().toISOString()}:`);
console.log(`- Total files loaded: ${linkFiles.length}`);
console.log(`- Technology items found: ${allLinks.length}`);
if (allLinks.length > 0) {
  console.log(`- Latest tech item: ${allLinks[0].title} (${allLinks[0].publishedAt})`);
  console.log(`- Oldest tech item: ${allLinks[allLinks.length-1].title} (${allLinks[allLinks.length-1].publishedAt})`);
}

// Sort by published date
allLinks.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// Pagination logic
const ARTICLES_PER_PAGE = 25;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const totalPages = Math.ceil(allLinks.length / ARTICLES_PER_PAGE);
const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
const endIndex = startIndex + ARTICLES_PER_PAGE;
const displayedLinks = allLinks.slice(startIndex, endIndex);

// Pagination info
const showingStart = startIndex + 1;
const showingEnd = Math.min(endIndex, allLinks.length);
const hasPrevPage = currentPage > 1;
const hasNextPage = currentPage < totalPages;


---

<Layout title="Technology & Innovation - Markets Feeds" description="Latest technology news, analysis and innovation insights">
  
  <div class="container max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-12 overflow-x-hidden">
    <CategoryHeader title="Technology & Innovation" currentPage="technology" />
    
    <Navigation currentPage="technology" />
    
    
    <!-- Pagination Info -->
    {allLinks.length > 0 && (
      <div class="mb-6 text-sm text-text-subtle text-center">
        Showing {showingStart}-{showingEnd} of {allLinks.length} technology articles
      </div>
    )}
    
    <!-- Feed Items -->
    <div class="space-y-0">
      {displayedLinks.length === 0 ? (
        <div class="text-center py-12">
          <p class="text-text-subtle">No technology content available at the moment.</p>
        </div>
      ) : (
        displayedLinks.map((link) => (
          <LinkCard link={link} />
        ))
      )}
    </div>
    
    <!-- Pagination Controls -->
    {totalPages > 1 && (
      <div class="flex justify-center items-center gap-4 mt-8 pt-8 border-t border-border">
        {hasPrevPage ? (
          <a 
            href={`/technology?page=${currentPage - 1}`}
            class="flex items-center gap-2 px-4 py-2 text-sm bg-card border border-border rounded-lg hover:bg-card-hover transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Previous
          </a>
        ) : (
          <div class="flex items-center gap-2 px-4 py-2 text-sm text-text-subtle">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Previous
          </div>
        )}
        
        <span class="text-sm text-text-subtle">
          Page {currentPage} of {totalPages}
        </span>
        
        {hasNextPage ? (
          <a 
            href={`/technology?page=${currentPage + 1}`}
            class="flex items-center gap-2 px-4 py-2 text-sm bg-card border border-border rounded-lg hover:bg-card-hover transition-colors"
          >
            Next
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        ) : (
          <div class="flex items-center gap-2 px-4 py-2 text-sm text-text-subtle">
            Next
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        )}
      </div>
    )}
  </div>
</Layout>