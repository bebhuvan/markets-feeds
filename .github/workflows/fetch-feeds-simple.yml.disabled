name: Fetch RSS Feeds (Simple)

on:
  schedule:
    # Test with just one time first - 6:00 AM IST = 12:30 AM UTC
    - cron: '30 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  fetch-feeds:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js (no cache)
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Navigate to v2 directory
      run: ls -la && cd v2 && ls -la
    
    - name: Install dependencies
      run: |
        cd v2
        npm --version
        node --version
        npm install
    
    - name: Test script exists
      run: |
        cd v2
        ls -la src/scripts/
        cat package.json | grep fetch-feeds
    
    - name: Fetch RSS feeds
      run: |
        cd v2
        npm run fetch-feeds
      env:
        NODE_ENV: production
    
    - name: Check for changes
      run: |
        git status
        ls -la v2/content/links/
    
    - name: Commit and push changes (if any)
      run: |
        git config --global user.name 'Feed Bot'
        git config --global user.email 'bot@markets-feeds.com'
        
        if [ -n "$(git status --porcelain v2/content/links/)" ]; then
          # Pull latest changes first
          git pull --rebase origin main
          
          git add v2/content/links/*.json
          # Try to add fetch report if it exists and is not ignored
          if [ -f "v2/fetch-report.json" ]; then
            git add -f v2/fetch-report.json 2>/dev/null || echo "Note: fetch-report.json is gitignored"
          fi
          git commit -m "ü§ñ Update feeds - $(date -u +'%Y-%m-%d %H:%M UTC')"
          
          # Retry push with pull if it fails
          for i in 1 2 3; do
            if git push; then
              echo "‚úÖ Changes pushed to repository"
              break
            else
              echo "‚ö†Ô∏è Push failed, pulling and retrying (attempt $i/3)..."
              git pull --rebase origin main
              sleep 2
            fi
          done
        else
          echo "‚ÑπÔ∏è No new articles to commit"
        fi
    
    - name: Upload logs (if exists)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: fetch-logs
        path: |
          v2/fetch-report.json
          v2/*.log
        retention-days: 3
        if-no-files-found: ignore